<!DOCTYPE html>
<html>

<head>
    <title>Chatbot</title>
    <style>
        body {
            font-family: Arial;
            margin-top: 0px;
            margin-bottom: 0px;
            background: linear-gradient(rgb(99, 99, 99), gray, rgb(99, 99, 99));
        }

        .send-button {
            background-color: rgb(4, 59, 34);
            color: white;
            padding: 12px 20px;
            margin-left: 10px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            cursor: pointer;
            transition: all .3s ease;
        }

        .send-button:hover {
            background: lightgreen;
            color: black;
        }

        .chat-input {
            padding: 12px 15px;
            border-radius: 10px;
            border-width: 1px;
            font-size: 15px;
            flex-grow: 1;
        }

        .chat-input-container {
            display: flex;
            margin-bottom: 60px;
        }

        .app-container {
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .chat-message-user {
            display: flex;
            justify-content: end;
            align-items: start;
        }

        .chat-message-robot {
            display: flex;
            align-items: start;
        }

        .chat-message-text {
            background-color: rgb(238, 238, 238);
            padding: 15px 20px;
            border-radius: 10px;
            margin-right: 10px;
            margin-left: 10px;
            margin-bottom: 20px;
            max-width: 300px;
        }

        .chat-message-profile {
            width: 45px;
            border-radius: 50%;
        }

        .chat-messages-container {
            flex-grow: 1;
            margin-top: 20px;
            overflow: scroll;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .welcome-message {
            color: white;
            text-align: center;
        }

        .loading-spinner {
            margin: -15px;
            height: 40px;
        }
    </style>
</head>

<body>
    <div class="js-container"></div>
    <script src="https://unpkg.com/supersimpledev/react.js"></script>
    <script src="https://unpkg.com/supersimpledev/react-dom.js"></script>
    <script src="https://unpkg.com/supersimpledev/chatbot.js"></script>
    <script src="https://unpkg.com/supersimpledev/babel.js"></script>
    <script type="text/babel">

        function ChatInput({ chatMessages, setChatMessages }) {

            const [inputText, setInputText] = React.useState('');
            const [isLoading, setIsLoading] = React.useState(false);

            function saveInputText(event) {
                setInputText(event.target.value);
            }

            async function sendMessage() {

                if (isLoading || inputText === '') {
                    return;
                }

                // Set isLoading to true at the start, and set it to false after everything is done.
                setIsLoading(true);

                // Clear the textbox at the top now because the Chatbot will take some time to load the response. We want to clear the textbox immediately rather waiting for the Chatbot to finish loading.
                setInputText('');

                const newChatMessages = [
                    ...chatMessages,
                    {
                        message: inputText,
                        sender: 'user',
                        id: crypto.randomUUID()
                    }
                ];

                setChatMessages([
                    ...newChatMessages,
                    // This creates a temporary gif spinner message because we don't save this message in newChatMessages it will be removed later, when we add the response.
                    {
                        message: <img
                            src="https://supersimple.dev/images/loading-spinner.gif"
                            className="loading-spinner"
                        />,
                        sender: 'robot',
                        id: crypto.randomUUID()
                    }
                ]);

                const response = await Chatbot.getResponseAsync(inputText);

                setChatMessages([
                    ...newChatMessages,
                    {
                        message: response,
                        sender: 'robot',
                        id: crypto.randomUUID()
                    }
                ]);

                // Set isLoading to false after everything is done.
                setIsLoading(false);
            }

            function handleKeyDown() {
                if (event.key === 'Enter') {
                    sendMessage();
                } else if (event.key === 'Escape') {
                    setInputText('');
                }
            }

            return (
                <div className="chat-input-container">
                    <input
                        required
                        placeholder="Send a message to Chatbot"
                        size="30"
                        onKeyDown={handleKeyDown}
                        onChange={saveInputText}
                        value={inputText}
                        className="chat-input"
                    />
                    <button
                        onClick={sendMessage}
                        className="send-button"
                    >Send</button>
                </div>
            );
        }

        function ChatMessage({ message, sender }) {

            // const message = props.message;
            // const sender = props.sender;
            // const { message, sender } = props;
            /*
            if (sender === 'robot') {
              return (
                <div>
                  <img src="robot.png" width="50" />
                  {message}
                </div>
              );
            }
            */

            return (
                <div className={
                    sender === 'user'
                        ? 'chat-message-user'
                        : 'chat-message-robot'
                }>
                    {sender === 'robot' && (
                        <img src="https://i.pinimg.com/736x/a1/51/b7/a151b738859875afc2e63a53f68572f4.jpg" className="chat-message-profile" />
                    )}
                    <div className="chat-message-text">
                        {message}
                    </div>
                    {sender === 'user' && (
                        <img src="https://tr.rbxcdn.com/180DAY-d4a6d1564bf7c0e65447501bdb3cc584/420/420/FaceAccessory/Png/noFilter" className="chat-message-profile" />
                    )}
                </div>
            );
        }

        function useAutoScroll(dependencies) {
            // To use a function as a hook, the function name must start with "use".

            const containerRef = React.useRef(null);

            React.useEffect(() => {

                const containerElem = containerRef.current;

                if (containerElem) {
                    containerElem.scrollTop = containerElem.scrollHeight;
                }

            }, dependencies);

            return containerRef;
        }

        function ChatMessages({ chatMessages }) {

            const chatMessagesRef = useAutoScroll([chatMessages]);

            return (
                <div className="chat-messages-container" ref={chatMessagesRef}>
                    {chatMessages.map((chatMessage) => {
                        return (
                            <ChatMessage
                                message={chatMessage.message}
                                sender={chatMessage.sender}
                                key={chatMessage.id}
                            />
                        );
                    })}
                </div>
            );
        }

        function App() {

            const [chatMessages, setChatMessages] = React.useState([]);
            // const [chatMessages, setChatMessages] = array;
            // const chatMessages = array[0];
            // const setChatMessages = array[1];

            return (
                <div className="app-container">
                    {chatMessages.length === 0 && (
                        <p className="welcome-message">
                            Welcome to my chatbot. It can say Hello, Flip a Coin & Roll a Dice.
                        </p>
                    )}
                    <ChatMessages
                        chatMessages={chatMessages}
                    />
                    <ChatInput
                        chatMessages={chatMessages}
                        setChatMessages={setChatMessages}
                    />
                </div>
            );
        }

        const container = document.querySelector('.js-container');
        ReactDOM.createRoot(container).render(<App />);
    </script>
</body>

</html>
